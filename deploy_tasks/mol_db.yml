- name: Clone MolDB git repository
  git: >
    dest={{ sm_mol_db_home }}
    repo=https://github.com/METASPACE2020/sm-molecular-db.git
    update=yes
    force=yes
    version={{ sm_mol_db_branch }}
  when: local_deploy is not defined
  register: git_deploy
  until: git_deploy | succeeded

- name: Upload local files
  synchronize:
    src: "{{ sm_mol_db_home }}/"
    dest: "{{ sm_mol_db_home }}/"
    rsync_opts:
      - "--exclude='conf/*' --exclude='logs' --exclude='.*'"
  when: local_deploy is defined

- name: Copy database import files
  get_url:
    url: "{{ item['url'] }}"
    dest: "/tmp/{{ item['url'] | basename }}"
  with_items: "{{ sm_mol_db_imports }}"

- name: Import databases
  shell: |
    source activate mol_db && \
    cd {{ sm_mol_db_home }} && \
    python scripts/import_molecular_db.py \
      {{ item['name'] }} \
      {{ item['version'] }} \
      /tmp/{{ item['url'] | basename }}
  args:
    executable: /bin/bash
  with_items: "{{ sm_mol_db_imports }}"

- name: Create directory for molecular structure images
  become: yes
  file: path={{ sm_mol_db_image_dir }} state=directory owner=ubuntu group=ubuntu

- name: Copy molecular structure images
  become: yes
  unarchive:
    src: "{{ item }}"
    dest: "{{ sm_mol_db_image_dir }}"
    remote_src: True
    owner: ubuntu
    group: ubuntu
  with_items: "{{ sm_mol_db_image_archives }}"

- include: ../restart_supervisor.yml supervisor_app=sm-mol-db
